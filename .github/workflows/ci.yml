name: CI

on:
    push:
        branches: [ main, master ]
    pull_request:
        branches: [ main, master ]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: "Debug: list plugin folder"
              shell: pwsh
              run: |
                  Write-Host "Workspace: $env:GITHUB_WORKSPACE"
                  $plugin = Join-Path $env:GITHUB_WORKSPACE 'Plugins\event-calendar-dev'
                  if (Test-Path $plugin) {
                      Get-ChildItem -Path $plugin -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
                  } else {
                      Write-Host "Plugin folder not found: $plugin"
                  }

            - name: "Build .op package"
              shell: pwsh
              run: |
                  pwsh -NoProfile -ExecutionPolicy Bypass -Command "& '${{ github.workspace }}/Plugins/event-calendar-dev/build-op.ps1' -IncludeTests"

            - name: "Verify artifact"
              shell: pwsh
              run: |
                  pwsh -NoProfile -ExecutionPolicy Bypass -Command "& '${{ github.workspace }}/Plugins/event-calendar-dev/tools/verify-release.ps1'"

            - name: "Upload artifact"
              uses: actions/upload-artifact@v4
              with:
                  name: event-calendar-op
                  path: Plugins/event-calendar-dev/event-calendar-dev.op
